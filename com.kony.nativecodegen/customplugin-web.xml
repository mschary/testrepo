<?xml version="1.0" encoding="UTF-8"?>
<project name="build" default="deploy" basedir="." xmlns:artifact="antlib:org.apache.maven.artifact.ant">
 	
     <target name="init">
		<taskdef resource="net/sf/antcontrib/antcontrib.properties" />
     	<property file="D:\cruisecontrol\projects\konyplatform\cruisecontrol\trunk\nativecodegen_plugin\build.property" />
		<property file="../../ccbuild.properties"/>
		<property name="plugin.loc" location="dist"/>
 	    <property name="temp.dir" location="pluginupdatesite"/>
    	<property name="dest.dir" location="D:\apache-tomcat-7.0.2\webapps\dashboard\konyplatform_custom_plugin\updatesite"/>
     	<property name="timestamp" value="${IDECOREDEPENDENCY}"/>
     	
     	<!-- <condition property="plugin.version" value="2.0.0.R${build}" else="2.0.0.${branch}${build}">
			<equals arg1="bbj2me" arg2="${branch}" casesensitive="false" trim="true"/>
		</condition> -->
				
		<echo message="pulgin version:${plugin.version}"/>
		<echo message="branch:${branch}"/>
		<echo message="build:${build}"/>
     </target>
     	     	
     <target name="publish" depends="init, clean">
     	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		  <classpath>
		    <pathelement location="lib/ant-contrib-0.6.jar"/>
		  </classpath>
		</taskdef>
		<tstamp/>
      
      <mkdir dir="${dest.dir}/${timestamp}"/>
      <!-- <mkdir dir="${dest.dir}/${timestamp}/features"/> -->
      <mkdir dir="${dest.dir}/${timestamp}/plugins"/>
     	
	  <copy todir="${dest.dir}/${timestamp}/plugins">
			<fileset dir="${plugin.loc}">
				<include name="*.jar"/>
			</fileset>
		</copy>
     	
		<!--<copyfile src="${temp.dir}/feature-template.xml" dest="${temp.dir}/feature.xml" forceoverwrite="true"/>
		<replace file="${temp.dir}/feature.xml" token="{PLUGIN-VERS}" value="${plugin.version}"/>    	
		<replace file="${temp.dir}/feature.xml" token="{DEP-CORE-PLUGIN-VER}" value="${IDECOREDEPENDENCY}"/>
		
       	<copyfile src="${temp.dir}/site-template.xml" dest="${temp.dir}/site.xml" forceoverwrite="true"/>
		<replace file="${temp.dir}/site.xml" token="{PLUGIN-VERS}" value="${plugin.version}"/>
       	   
	   <jar destfile="${temp.dir}/features/com.kony.nativecodegen_${plugin.version}.jar" basedir="${temp.dir}" excludes="**/feature-template.xml, **/site-template.xml, **/site.xml"/> -->
	   
       <!-- Sign the Final Feature Jar -->
		<!-- <signjar           
            jar="${dest.dir}/${timestamp}/features/com.kony.nativecodegen_${plugin.version}.jar"
            keystore="${key.store}"
			storepass="kony123"
            alias="KonyKeys"
            keypass="kony123" />
			
       	<copy file="${temp.dir}/site.xml" todir="${dest.dir}/${timestamp}/"/>	-->  
     </target>
	

	<target name="deploy" depends="publish">
		<property name="nexus_repo_url" value="http://10.10.6.9:8081/nexus/content/repositories" />
		<property name="ftp_server" value="10.10.6.38" />
		<property name="ftp_user" value="user" />
		<property name="ftp_passwd" value="user123" />
		<property name="ftp_dir" value="/50" />
		<property name="feature_jar_name" value="com.kony.nativecodegen" />
		<property name="plugin_jar_name" value="com.kony.nativecodegen" />

		<if>
			<equals arg1="${envt}" arg2="QA" />
				<then>
					<!--<artifact:mvn failonerror="true">
						<arg value="org.apache.maven.plugins:maven-deploy-plugin:2.6:deploy-file" />
						<arg value="-Durl=${nexus_repo_url}/${envt}" />
						<arg value="-DrepositoryId=${envt}" />						
						<arg value="-DgroupId=features" />
						<arg value="-DartifactId=${feature_jar_name}" />
						<arg value="-Dversion=${plugin.version}" />
						<arg value="-Dfile=${dest.dir}/${timestamp}/features/${feature_jar_name}_${plugin.version}.jar" />
					</artifact:mvn> -->
					<artifact:mvn failonerror="true">
						<arg value="org.apache.maven.plugins:maven-deploy-plugin:2.6:deploy-file" />
						<arg value="-Durl=${nexus_repo_url}/${envt}" />
						<arg value="-DrepositoryId=${envt}" />						
						<arg value="-DgroupId=plugins" />
						<arg value="-DartifactId=${plugin_jar_name}" />
						<arg value="-Dversion=${plugin.version}" />
						<arg value="-Dfile=${dest.dir}/${timestamp}/plugins/${plugin_jar_name}_${plugin.version}.jar" />
					</artifact:mvn>	

					<echo message=" Uploading QA-Plugins to Maven Repo: http://10.10.6.9:8081/nexus/content/repositories/QA Done" />

				</then>
		</if>
		
		<if>
			<equals arg1="${envt}" arg2="GA" />
				<then>
				<!--	<artifact:mvn failonerror="true">
						<arg value="org.apache.maven.plugins:maven-deploy-plugin:2.6:deploy-file" />
						<arg value="-Durl=${nexus_repo_url}/${envt}" />
						<arg value="-DrepositoryId=${envt}" />						
						<arg value="-DgroupId=features" />
						<arg value="-DartifactId=${feature_jar_name}" />
						<arg value="-Dversion=${plugin.version}" />
						<arg value="-Dfile=${dest.dir}/${timestamp}/features/${feature_jar_name}_${plugin.version}.jar" />
					</artifact:mvn>  -->
					<artifact:mvn failonerror="true">
						<arg value="org.apache.maven.plugins:maven-deploy-plugin:2.6:deploy-file" />
						<arg value="-Durl=${nexus_repo_url}/${envt}" />
						<arg value="-DrepositoryId=${envt}" />						
						<arg value="-DgroupId=plugins" />
						<arg value="-DartifactId=${plugin_jar_name}" />
						<arg value="-Dversion=${plugin.version}" />
						<arg value="-Dfile=${dest.dir}/${timestamp}/plugins/${plugin_jar_name}_${plugin.version}.jar" />
					</artifact:mvn>	

					<echo message=" Uploading GA-Plugins to Maven Repo: http://10.10.6.9:8081/nexus/content/repositories/GA Done" />
					
					<!--
					<ftp	server="${ftp_server}" 
							remotedir="${ftp_dir}/features" 
							userid="${ftp_user}" 
							password="${ftp_passwd}" 
							passive="yes" 
							depends="yes" 
							binary="yes"
							verbose="yes"
							retriesAllowed="3"
							skipFailedTransfers="yes" >

					<fileset dir="${dest.dir}/${timestamp}/features/">
					  <include name="${artifactId}_${plugin.version}.jar"/>
					</fileset>

				   </ftp> -->
					<ftp	server="${ftp_server}" 
							remotedir="${ftp_dir}/plugins" 
							userid="${ftp_user}" 
							password="${ftp_passwd}" 
							passive="yes" 
							depends="yes" 
							binary="yes"
							verbose="yes"
							retriesAllowed="3"
							skipFailedTransfers="yes" >

					<fileset dir="${plugin.loc}">
					  <include name="*.jar"/>
					</fileset>

				  </ftp>

					<echo message=" Uploading GA-Plugins to Local Update Site is Done" />

				</then>
		</if>
		
	</target>


	 <target name="clean">
	</target>
	
 </project>
