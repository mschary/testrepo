<project name="intellisensedebug_plugin" default="build">	
	<target name="build">
	<taskdef resource="net/sf/antcontrib/antcontrib.properties" />
	<property name="label" value="1"/>
	<property file="${basedir}\build.property" />
	<echo message="Executing the build ${label}"/>
	<echo message="Working Branch - ${target.branch}"/>
	<available file="${basedir}\branch-not-exist" property="isexist"/>
		<if>
		<equals arg1="${isexist}" arg2="true" />
		<then>
			<echo message="Sorry.. Your plugin project depends on 2 repositories. Specified branch is not existing on one of the remote repositories...."/>
			<echo />
			
			<loadfile property="errormessage"
				srcFile="branch-not-exist"/>
			<echo message="${errormessage}"/>
			<fail message="Something wrong here."/>
		</then>
		<else>
			<tstamp/>
			<!-- find the plugin version. If Custom label is  platform-branch-major.minor.releasnumber.patch format.  Then plugin-version=major.minor.releasenumber.patchnum -->
			<propertyregex
				property="tlabel"
				input="${label}"
				regexp="(.*)-(.*)-(\d)\.(\d+)\.(\d+)\.(\d+)$"
				select="\1-\2-\3.\4.\5_v${DSTAMP}${TSTAMP}_r\6"/>
		
			<propertyregex
				property="plugin.version"
				input="${label}"
				regexp="(.*)-(.*)-(\d)\.(\d+)\.(\d+)\.(\d+)$"
				select="\3.\4.\5.\2_v${DSTAMP}${TSTAMP}_r\6"/>
			
		
			<!-- find the plugin version. If Custom label is  platform-branch-major.minor.releasnumber format.  Then plugin-version=major.minor.releasenumber -->
			<propertyregex
				property="tlabel"
				input="${label}"
				regexp="(.*)-(.*)-(\d)\.(\d+)\.(\d+)$"
				select="\1-\2-\3.\4.\5_v${DSTAMP}${TSTAMP}"/> 

			<propertyregex
				property="plugin.version"
				input="${label}"
				regexp="(.*)-(.*)-(\d)\.(\d+)\.(\d+)$"
				select="\3.\4.\5.\2_v${DSTAMP}${TSTAMP}"/> 

			<!-- find the plugin version. If Custom label is  platform-branch-major.minor format. Then plugin-version=major.minor.0 -->
			<propertyregex
				property="tlabel"
				input="${label}"
				regexp="(.*)-(.*)-(\d)\.(\d)$"
				select="\1-\2-\3.\4.0_v${DSTAMP}${TSTAMP}"/> 
		
			<propertyregex
				property="plugin.version"
				input="${label}"
				regexp="(.*)-(.*)-(\d)\.(\d)$"
				select="\3.\4.0.\2_v${DSTAMP}${TSTAMP}"/> 
			
			<!-- If Custom label is other format, assign target.branch value to plugin-environment -->
			<!-- Replace . character with _ for the plugin.version -->		
			<propertyregex property="Rtarget.branch"
				input="${target.branch}"
				regexp="\."
				replace="_"
				global="true" />
			   
			<condition property="Rtarget.branch" value="${target.branch}">
				<not>  
					<isset property="Rtarget.branch"/>
				</not>
			</condition>

			<propertyregex
				property="envmnt"
				input="${label}"
				regexp="(.*)-(.*)-(\d)\.(\d+)\.(\d+)\.(\d+)$"
				select="\2"/>
		
			<propertyregex
				property="envmnt"
				input="${label}"
				regexp="(.*)-(.*)-(\d)\.(\d+)\.(\d+)$"
				select="\2"/>
	
			<property name="envmnt" value="${Rtarget.branch}" />
	
			<condition property="plugin.version" value="3.0.${LABELNUM}.${envmnt}_v${DSTAMP}${TSTAMP}" else="3.0.0.${envmnt}_v${DSTAMP}${TSTAMP}">
				<matches pattern=".+_plugin-.+\.[0-9]+" string="${LABEL}"/>
			</condition>

			<property name="tlabel" value="${label}_v${DSTAMP}${TSTAMP}" />
	
			<!--	<replace file="${ant.project.name}-label.properties" token="LABEL=" value="LABEL=${tlabel}"/>-->
	
			<!--####################-->
			
	        <delete file="../../../ccbuild.properties"/>
	        <delete file="../../../version.html"/>

	        <touch file="../../../ccbuild.properties"/>
	        <concat destfile="../../../ccbuild.properties" append="true" fixlastline="yes">ds=${DSTAMP}${line.separator}</concat>
	        <concat destfile="../../../ccbuild.properties" append="true" fixlastline="yes">ts=${TSTAMP}${line.separator}</concat>
	        <concat destfile="../../../ccbuild.properties" append="true" fixlastline="yes">buildnum=${LABELNUM}${line.separator}</concat>
	        <concat destfile="../../../ccbuild.properties" append="true" fixlastline="yes">build=${tlabel}${line.separator}</concat>
	        <concat destfile="../../../ccbuild.properties" append="true" fixlastline="yes">platform.version=1.0.0${line.separator}</concat>
			<!-- <concat destfile="../../../ccbuild.properties" append="true" fixlastline="yes">jar-filename-change=${jar-filename-change}</concat>
			<concat destfile="../../../ccbuild.properties" append="true" fixlastline="yes">jar-filename=${jar-filename}</concat> -->
			<concat destfile="../../../ccbuild.properties" append="true" fixlastline="yes">LABEL=${tlabel}${line.separator}</concat>
			<concat destfile="../../../ccbuild.properties" append="true" fixlastline="yes">branch=${branch}${line.separator}</concat>

                <replace file="../../../ccbuild.properties" token="build." value=""/>

	        <touch file="../../../version.html"/>
	        <concat destfile="../../../version.html" append="true" fixlastline="yes">Build DATE = ${DSTAMP}${line.separator}</concat>
	        <concat destfile="../../../version.html" append="true" fixlastline="yes">Build Time = ${TSTAMP}${line.separator}</concat>
	        <concat destfile="../../../version.html" append="true" fixlastline="yes">Build Number =${LABELNUM}${line.separator}</concat>
	        <concat destfile="../../../version.html" append="true" fixlastline="yes">Build Branch =${branch}${line.separator}</concat>
        
		  <echo message="Compiling the Kony NativeCodegen Plugin"/>
		  <ant dir="../../../nativecodegen/com.kony.nativecodegen" antfile="plugin-compile.xml"/>
		  <echo message="Sucessfully Compiled the NativeCodegen Plugin"/>
		  
		  <echo message="Packaging the Kony NativeCodegen Plugin"/>
		  <ant dir="../../../nativecodegen/com.kony.nativecodegen" antfile="customplugin-build.xml">
			<property name="LABEL" value="${tlabel}"/>
			<property name="plugin.version" value="${plugin.version}"/>
			<property name="envt" value="${envmnt}"/>
		  </ant>
		  <echo message="Sucessfully Packaging the Kony NativeCodegen Plugin"/>
			
		</else>
		</if>
	</target>	
</project>
